---

- name: Load variables
  include_vars: "main.yml"

- name: Clone goenv projects
  include_tasks: git.yml
  vars:
    user: "{{ desktop_user }}"

- name: Add GOENV_ROOT
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'export GOENV_ROOT="$HOME/.goenv"'
    insertafter: "# PREPATH config:"

- name: Make goenv not do GOPATH configuration
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'export GOENV_DISABLE_GOPATH=1'
    insertafter: "# PREPATH config:"

- name: Add goenv to PATH
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'PATH="$GOENV_ROOT/bin:$PATH"'
    insertafter: "# PATH config:"

- name: Add goenv shims to PATH
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'PATH="$GOENV_ROOT/bin:$PATH"'
    insertafter: "# PATH config:"

# goenv must be initialized before the environment variables are set, otherwise
# the PATH will point to the wrong binaries.
- name: Initialize goenv
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshrc"
    line: 'eval "$(goenv init -)"'

- name: Set GOPATH
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'export GOPATH="{{ GOPATH }}"'
    insertbefore: "export PATH"

- name: Ensure GOPATH exists
  become: yes
  become_user: "{{ desktop_user.username }}"
  file:
    path: "{{ GOPATH }}"
    state: directory
    mode: '0755'

- name: Add GOPATH binary to PATH
  become: yes
  become_user: "{{ desktop_user.username }}"
  lineinfile:
    dest: "~/.zshenv"
    line: 'PATH="$GOPATH/bin:$PATH"'
    insertbefore: "export PATH"

- name: Install go
  become: yes
  become_user: "{{ desktop_user.username }}"
  shell: source ~/.zshrc; goenv install -s "{{ GOVERSION }}"
  args:
    executable: "{{ ZSH_BIN }}"

- name: Set default go version
  become: yes
  become_user: "{{ desktop_user.username }}"
  shell: source ~/.zshrc; goenv global "{{ GOVERSION }}"
  args:
    executable: "{{ ZSH_BIN }}"

- name: Install spacemacs required packages
  become: yes
  become_user: "{{ desktop_user.username }}"
  shell: source ~/.zshrc; go get -u -v "{{ item }}"
  args:
    executable: "{{ ZSH_BIN }}"
  with_items:
    - "github.com/nsf/gocode"
    - "github.com/rogpeppe/godef"
    - "golang.org/x/tools/cmd/guru"
    - "golang.org/x/tools/cmd/gorename"
    - "golang.org/x/tools/cmd/goimports"
    - "golang.org/x/tools/gopls"
